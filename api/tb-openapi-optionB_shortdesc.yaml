openapi: 3.1.0
info:
  title: TB Clinical Mentor Actions API
  version: 1.3.0
  description: >
    Action surface for the TB Clinical Mentor GPT. Clinicians send a free-form
    TB question and the action returns the most relevant guideline passages
    from the local RAG store based on WHO TB modules.
  contact:
    name: TB Clinical Mentor
    url: https://chatgpt.com/g/g-68e126775224819193328c1977555fd0-tb-clinical-mentor-v2
  license:
    name: Creative Commons Attribution 4.0 International
    url: https://creativecommons.org/licenses/by/4.0/
security: []
servers:
  - url: "https://rag-two-rouge.vercel.app"
    description: This is the production domain that hosts this API.
paths:
  /api/tb-rag-query:
    post:
      operationId: fetchRelevantTbGuidance
      summary: Retrieve relevant TB guidance passages
      description: >
        Embed a clinician TB question and return the top-matching WHO TB
        handbook or guideline passages from the on-device RAG store. Use this
        before giving case-specific TB advice.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        "200":
          description: Top passages ordered by similarity to the clinician question.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
              examples:
                default:
                  summary: Example response
                  value:
                    question: What are the recommended monitoring steps for a patient on bedaquiline?
                    top_k: 8
                    scope: "treatment"
                    results:
                      - doc_id: tb_handbook_v3
                        guideline_title: "WHO operational handbook on tuberculosis, Module 4: treatment"
                        year: 2022
                        chunk_id: chunk-01752
                        section_path: Chapter 4 > Drug-Resistant TB > Monitoring
                        text: >
                          For patients receiving bedaquiline, monitor liver function tests weekly for
                          the first month, then monthly thereafter. Electrocardiograms should be
                          obtained ...
                        attachment_id: bedaquiline-monitoring.pdf
                        attachment_path: attachments/bedaquiline-monitoring.pdf
                        score: 0.8123
        "400":
          description: Missing or malformed question field.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "405":
          description: Only POST is supported on this endpoint.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "500":
          description: Retrieval or embedding failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    QueryRequest:
      type: object
      additionalProperties: false
      required:
        - question
      properties:
        question:
          type: string
          description: >
            Free-form clinician question about a TB patient. Include enough
            clinical context (age, HIV status, comorbidities, prior treatment,
            and resource setting) to retrieve relevant guidance.
          minLength: 1
          examples:
            - How should I adjust the regimen for a TB/HIV co-infected patient with renal impairment?
        top_k:
          type: integer
          description: >
            Desired number of passages to return. Defaults to 8 and supports
            between 1 and 8 results.
          minimum: 1
          maximum: 8
          default: 8
          examples:
            - 8
        scope:
          type: string
          description: >
            Optional topic hint to focus retrieval on part of the TB corpus.
            Supported values:
            - "prevention" for TB infection, TPT, contact management, and IPC.
            - "screening" for systematic screening and triage.
            - "diagnosis" for diagnostic algorithms and pathways.
            - "treatment" for regimens, dosing, monitoring, toxicity, and failure.
            Pediatrics, pregnancy, HIV, diabetes, and other comorbid conditions
            should be expressed in the question text, not as scope values.
          enum: [prevention, screening, diagnosis, treatment]
          examples:
            - diagnosis
    QueryResponse:
      type: object
      additionalProperties: false
      required:
        - question
        - top_k
        - results
      properties:
        question:
          type: string
          description: Echo of the received clinician question.
        top_k:
          type: integer
          description: Number of passages returned in results.
        results:
          type: array
          description: Relevant TB guidance passages ordered by similarity.
          items:
            $ref: '#/components/schemas/QueryResult'
    QueryResult:
      type: object
      additionalProperties: false
      required:
        - doc_id
        - chunk_id
        - section_path
        - text
        - score
      properties:
        doc_id:
          type: string
          description: Identifier of the source document within the RAG corpus.
        guideline_title:
          type:
            - string
            - "null"
          description: Human-readable title of the guideline or handbook, if available.
        year:
          type:
            - integer
            - "null"
          description: Publication year of the guideline module, if available.
        chunk_id:
          type: string
          description: Unique identifier of the chunk within the document.
        section_path:
          type: string
          description: Breadcrumb-style path pointing to the relevant guideline section.
        text:
          type: string
          description: Excerpt of the guideline passage to show to clinicians.
        attachment_id:
          type:
            - string
            - "null"
          description: Optional attachment identifier if files are associated with the passage.
        attachment_path:
          type:
            - string
            - "null"
          description: Optional relative path to download the associated attachment.
        score:
          type: number
          format: float
          description: Cosine similarity score where higher values mean a closer match.
    ErrorResponse:
      type: object
      additionalProperties: false
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message.
